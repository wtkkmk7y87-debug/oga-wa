<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPSãƒŠãƒ“ï¼ˆå®Œæˆç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

#gpsBtn{
  position:fixed;
  top:15px;
  left:15px;
  z-index:1000;
  font-size:20px;
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#2c7be5;
  color:white;
}

#legend{
  position:fixed;
  bottom:15px;
  right:15px;
  z-index:1000;
  background:rgba(255,255,255,0.9);
  padding:10px;
  border-radius:8px;
  font-size:14px;
}
</style>
</head>

<body>
<button id="gpsBtn">GPSã‚’è¡¨ç¤º</button>

<div id="legend">
  <div>ğŸš© ç¾åœ¨åœ°</div>
  <div>ğŸ ç›®çš„åœ°</div>
  <div>â” ç°è‰²ï¼šé“</div>
</div>

<div id="map"></div>

<script>
/* ===============================
â‘  ç”»åƒã‚µã‚¤ã‚º
================================ */
const imageWidth  = 1264;
const imageHeight = 1295;

/* ===============================
â‘¡ GPS â†’ ç”»åƒå¤‰æ›ï¼ˆæˆåŠŸã—ã¦ã‚‹å€¤ï¼‰
================================ */
const controlPoints = [
  { img:{x:179,y:1211}, gps:{lat:35.640376,lng:139.294706} },
  { img:{x:2894,y:697}, gps:{lat:35.641230,lng:139.300170} },
  { img:{x:140,y:2262}, gps:{lat:35.638620,lng:139.294578} },
  { img:{x:3239,y:2442}, gps:{lat:35.638278,lng:139.300813} }
];

function computeAffine(points){
  let A=[],B=[];
  points.forEach(p=>{
    const lng=p.gps.lng, lat=-p.gps.lat;
    A.push([lng,lat,1,0,0,0],[0,0,0,lng,lat,1]);
    B.push(p.img.x,p.img.y);
  });
  const X=math.multiply(
    math.inv(math.multiply(math.transpose(A),A)),
    math.multiply(math.transpose(A),B)
  );
  return {a:X[0],b:X[1],c:X[2],d:X[3],e:X[4],f:X[5]};
}
const affine = computeAffine(controlPoints);

function gpsToImage(lat,lng){
  lat=-lat;
  return {
    x: affine.a*lng + affine.b*lat + affine.c,
    y: affine.d*lng + affine.e*lat + affine.f
  };
}

/* ===============================
â‘¢ åœ°å›³è¡¨ç¤º
================================ */
const bounds=[[0,0],[imageHeight,imageWidth]];
const map=L.map("map",{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
L.imageOverlay("map.jpg",bounds).addTo(map);
map.fitBounds(bounds);

/* ===============================
â‘£ ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç”»åƒï¼‰
================================ */
const currentIcon = L.icon({
  iconUrl: "current.png",
  iconSize: [40,40],
  iconAnchor: [20,20]
});

const goalIcon = L.icon({
  iconUrl: "goal.jpg",
  iconSize: [40,60],
  iconAnchor: [20,60]
});

/* ===============================
â‘¤ é“ãƒ‡ãƒ¼ã‚¿ï¼ˆâ˜…ã“ã“ã«ç‚¹ã‚’è¿½åŠ ï¼‰
================================ */
const roads = [
  [
    [320,573],
    [557,608],
    [769,599],
    [779,664],
    [779,730]
  ],
  [
    [779,730],
    [782,775],
    [771,821],
    [817,815],
    [997,838]
  ]
];

// é“ã‚’æç”»
roads.forEach(r=>{
  L.polyline(r.map(p=>[p[1],p[0]]),{
    color:"#999",
    weight:6
  }).addTo(map);
});

/* ===============================
â‘¥ ç¾åœ¨åœ°ï¼ˆGPSï¼‰
================================ */
let currentMarker=null;

document.getElementById("gpsBtn").onclick=()=>{
  navigator.geolocation.watchPosition(pos=>{
    const p=gpsToImage(pos.coords.latitude,pos.coords.longitude);
    if(!currentMarker){
      currentMarker=L.marker([p.y,p.x],{icon:currentIcon}).addTo(map);
    }else{
      currentMarker.setLatLng([p.y,p.x]);
    }
  },e=>alert(e.message),{enableHighAccuracy:true});
};

/* ===============================
â‘¦ ç›®çš„åœ°ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰
================================ */
let goalMarker=null;
map.on("click",e=>{
  if(goalMarker) map.removeLayer(goalMarker);
  goalMarker=L.marker(e.latlng,{icon:goalIcon}).addTo(map);
});
</script>
</body>
</html>
