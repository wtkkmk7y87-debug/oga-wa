<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPS ãƒŠãƒ“</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- â˜… æ•°å­¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆå¿…é ˆï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
button {
  position: fixed;
  left: 10px;
  top: 10px;
  z-index: 1000;
  padding: 6px 10px;
}
</style>
</head>

<body>
<button id="btn-gps">ğŸ“ GPSç¾åœ¨åœ°</button>
<div id="map"></div>

<script>
/* ===============================
 1ï¸âƒ£ åœ°å›³ç”»åƒã‚µã‚¤ã‚º
================================ */
const imageWidth  = 3312;
const imageHeight = 3392;

/* ===============================
 2ï¸âƒ£ ç”»åƒã¨GPSã®å¯¾å¿œç‚¹ï¼ˆ3ç‚¹ä»¥ä¸Šï¼‰
================================ */
const controlPoints = [
  {
    img: { x: 2453, y: 2214 },
    gps: { lat: 35.638694, lng: 139.300228 } //ä¸€æ£Ÿ
  },
  {
    img: { x: 1561, y: 1550 },
    gps: { lat: 35.639768, lng: 139.305469 }ã€€//ãƒ—ãƒ¼ãƒ«
  },
  {
    img: { x: 2938, y: 1696 },
    gps: { lat: 35.639524, lng: 139.300162 }ã€€//ä¸ƒæ£Ÿ
  }
];

/* ===============================
 3ï¸âƒ£ ã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›è¨ˆç®—
================================ */
function computeAffine(points) {
  let A = [], B = [];

  points.forEach(p => {
    const { lat, lng } = p.gps;
    A.push([lng, lat, 1, 0, 0, 0]);
    A.push([0, 0, 0, lng, lat, 1]);
    B.push(p.img.x);
    B.push(p.img.y);
  });

  const AT = math.transpose(A);
  const X  = math.multiply(
    math.inv(math.multiply(AT, A)),
    math.multiply(AT, B)
  );

  return { a: X[0], b: X[1], c: X[2], d: X[3], e: X[4], f: X[5] };
}

const affine = computeAffine(controlPoints);

/* ===============================
 4ï¸âƒ£ GPS â†’ ç”»åƒåº§æ¨™å¤‰æ›
================================ */
function gpsToImage(lat, lng) {
  return {
    x: affine.a * lng + affine.b * lat + affine.c,
    y: affine.d * lng + affine.e * lat + affine.f
  };
}

/* ===============================
 5ï¸âƒ£ Leaflet åˆæœŸåŒ–
================================ */
const bounds = [[0, 0], [imageHeight, imageWidth]];

const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2
});

L.imageOverlay('map.png', bounds).addTo(map);
map.fitBounds(bounds);

/* ğŸ”´ åŸºæº–ç‚¹ãƒ‡ãƒãƒƒã‚°ï¼ˆç¢ºèªç”¨ï¼‰ */
controlPoints.forEach(p => {
  const r = gpsToImage(p.gps.lat, p.gps.lng);
  L.circleMarker([r.y, r.x], {
    radius: 8,
    color: "red"
  }).addTo(map);
});

/* ===============================
 6ï¸âƒ£ ãƒãƒ¼ã‚«ãƒ¼ãƒ»ãƒ«ãƒ¼ãƒˆ
================================ */
let startMarker = null;
let goalMarker  = null;
let routeLine   = null;

function drawRoute() {
  if (!startMarker || !goalMarker) return;
  if (routeLine) map.removeLayer(routeLine);

  routeLine = L.polyline([
    startMarker.getLatLng(),
    goalMarker.getLatLng()
  ], {
    color: "blue",
    weight: 4
  }).addTo(map);
}

/* ===============================
 7ï¸âƒ£ GPSç¾åœ¨åœ°
================================ */
document.getElementById("btn-gps").onclick = () => {
  navigator.geolocation.getCurrentPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      const p = gpsToImage(latitude, longitude);

      if (startMarker) map.removeLayer(startMarker);

      startMarker = L.marker([p.y, p.x])
        .addTo(map)
        .bindPopup("ç¾åœ¨åœ°")
        .openPopup();

      drawRoute();
    },
    err => alert(err.message),
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );
};

/* ===============================
 8ï¸âƒ£ ç›®çš„åœ°è¨­å®š
================================ */
map.on("click", e => {
  if (goalMarker) map.removeLayer(goalMarker);

  goalMarker = L.marker(e.latlng)
    .addTo(map)
    .bindPopup("ç›®çš„åœ°")
    .openPopup();

  drawRoute();
});
</script>
</body>
</html>





