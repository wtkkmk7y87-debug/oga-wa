<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPSãƒŠãƒ“ï¼ˆå®Œæˆç‰ˆï¼‰</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- math.jsï¼ˆã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›ç”¨ï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}

/* GPSãƒœã‚¿ãƒ³ */
#gpsBtn {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1000;
  font-size: 18px;
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  background: #2c7be5;
  color: #fff;
}

/* çŠ¶æ…‹è¡¨ç¤º */
#status {
  position: fixed;
  bottom: 15px;
  left: 15px;
  z-index: 1000;
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 15px;
  display: none;
}

/* å‡¡ä¾‹ */
#legend {
  position: fixed;
  bottom: 15px;
  right: 15px;
  z-index: 1000;
  background: rgba(255,255,255,0.9);
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  line-height: 1.6;
}

/* ğŸ“ã‚¢ã‚¤ã‚³ãƒ³ */
.pin-blue {
  font-size: 48px;
  color: #1e6fff;
}
.pin-red {
  font-size: 48px;
  color: red;
}
</style>
</head>

<body>
<button id="gpsBtn">ğŸ“ GPSã‚’è¡¨ç¤º</button>
<div id="status"></div>

<div id="legend">
  <div>ğŸ”µğŸ“ãƒ»ãƒ»ãƒ»ç¾åœ¨åœ°</div>
  <div>ğŸ”´ğŸ“ãƒ»ãƒ»ãƒ»ç›®çš„åœ°</div>
</div>

<div id="map"></div>

<script>
/* ===============================
â‘  ç”»åƒã‚µã‚¤ã‚ºï¼ˆmap.jpgã®å®Ÿã‚µã‚¤ã‚ºï¼‰
================================ */
const imageWidth  = 3312;
const imageHeight = 3392;

/* ===============================
â‘¡ å¯¾å¿œç‚¹ï¼ˆGPS â‡” ç”»åƒï¼‰
================================ */
const controlPoints = [
  { img:{x:179,  y:1211}, gps:{lat:35.640376, lng:139.294706} },
  { img:{x:2894, y:697},  gps:{lat:35.641230, lng:139.300170} },
  { img:{x:140,  y:2262}, gps:{lat:35.638620, lng:139.294578} },
  { img:{x:3239, y:2442}, gps:{lat:35.638278, lng:139.300813} }
];

/* ===============================
â‘¢ ã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›è¨ˆç®—
================================ */
function computeAffine(points) {
  let A = [], B = [];
  points.forEach(p => {
    const lng = p.gps.lng;
    const lat = -p.gps.lat;
    A.push([lng, lat, 1, 0, 0, 0]);
    A.push([0, 0, 0, lng, lat, 1]);
    B.push(p.img.x, p.img.y);
  });
  const AT = math.transpose(A);
  const X = math.multiply(
    math.inv(math.multiply(AT, A)),
    math.multiply(AT, B)
  );
  return { a:X[0], b:X[1], c:X[2], d:X[3], e:X[4], f:X[5] };
}

const affine = computeAffine(controlPoints);

/* ===============================
â‘£ GPS â†’ ç”»åƒåº§æ¨™
================================ */
function gpsToImage(lat, lng) {
  lat = -lat;
  return {
    x: affine.a * lng + affine.b * lat + affine.c,
    y: affine.d * lng + affine.e * lat + affine.f
  };
}

/* ===============================
â‘¤ åœ°å›³åˆæœŸåŒ–
================================ */
const bounds = [[0,0],[imageHeight,imageWidth]];
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2
});
L.imageOverlay("map.jpg", bounds).addTo(map);
map.fitBounds(bounds);

/* ===============================
â‘¥ ğŸ“ã‚¢ã‚¤ã‚³ãƒ³
================================ */
function getPinSize() {
  const z = map.getZoom();
  return Math.max(32, 48 + z * 8);
}

function createPin(className) {
  const size = getPinSize();
  return L.divIcon({
    className,
    html: "ğŸ“",
    iconSize: [size, size],
    iconAnchor: [size/2, size]
  });
}

let currentMarker = null;
let goalMarker = null;
const status = document.getElementById("status");

/* ===============================
â‘¦ ã‚ºãƒ¼ãƒ æ™‚ã«ğŸ“ã‚µã‚¤ã‚ºæ›´æ–°
================================ */
map.on("zoom", () => {
  if (currentMarker) {
    currentMarker.setIcon(createPin("pin-blue"));
  }
  if (goalMarker) {
    goalMarker.setIcon(createPin("pin-red"));
  }
});

/* ===============================
â‘§ GPSè¡¨ç¤º
================================ */
document.getElementById("gpsBtn").onclick = () => {
  navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude, accuracy } = pos.coords;

      if (accuracy > 1000) {
        status.textContent = "ã“ã®ç«¯æœ«ã§ã¯æ­£ç¢ºãªä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“";
        status.style.display = "block";
        return;
      }

      const p = gpsToImage(latitude, longitude);

      // ç¯„å›²å¤–åˆ¤å®š
      if (
        p.x < 0 || p.x > imageWidth ||
        p.y < 0 || p.y > imageHeight
      ) {
        status.textContent = "ç¾åœ¨åœ°ã¯åœ°å›³ã®ç¯„å›²å¤–ã§ã™";
        status.style.display = "block";
        if (currentMarker) {
          map.removeLayer(currentMarker);
          currentMarker = null;
        }
        return;
      }

      status.style.display = "none";

      if (!currentMarker) {
        currentMarker = L.marker(
          [p.y, p.x],
          { icon: createPin("pin-blue") }
        ).addTo(map);
      } else {
        currentMarker.setLatLng([p.y, p.x]);
      }
    },
    err => {
      status.textContent = "GPSã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
      status.style.display = "block";
    },
    { enableHighAccuracy: true }
  );
};

/* ===============================
â‘¨ ç›®çš„åœ°ï¼ˆã‚¿ãƒƒãƒ—ã§è¨­å®šï¼‰
================================ */
map.on("click", e => {
  if (goalMarker) map.removeLayer(goalMarker);
  goalMarker = L.marker(
    e.latlng,
    { icon: createPin("pin-red") }
  ).addTo(map);
});
</script>
</body>
</html>
