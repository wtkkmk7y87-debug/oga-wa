<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPSãƒŠãƒ“ï¼ˆå®Œæˆç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { width:100%; height:100%; }

/* GPSãƒœã‚¿ãƒ³ */
#gpsBtn {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1000;
  font-size: 22px;
  padding: 12px 18px;
  border-radius: 10px;
  border: none;
  background: #2c7be5;
  color: white;
}

/* å‡¡ä¾‹ */
#legend {
  position: fixed;
  bottom: 15px;
  right: 15px;
  z-index: 1000;
  background: rgba(255,255,255,0.9);
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 16px;
}

/* ğŸ“ */
.pin-blue { font-size:48px; color:#1e6fff; }
.pin-red  { font-size:48px; color:red; }
</style>
</head>

<body>

<button id="gpsBtn">ğŸ“ GPSã‚’è¡¨ç¤º</button>

<div id="legend">
  <div>ğŸ”µğŸ“ãƒ»ãƒ»ãƒ»ç¾åœ¨åœ°</div>
  <div>ğŸ”´ğŸ“ãƒ»ãƒ»ãƒ»ç›®çš„åœ°</div>
</div>

<div id="map"></div>

<script>
/* ===============================
â‘  ç”»åƒã‚µã‚¤ã‚º
================================ */
const imageWidth  = 1264;
const imageHeight = 1295;

/* ===============================
â‘¡ GPS â†’ ç”»åƒå¤‰æ›ï¼ˆæˆåŠŸæ¸ˆã¿ï¼‰
================================ */
const controlPoints = [
  { img:{x:179,y:1211}, gps:{lat:35.640376,lng:139.294706} },
  { img:{x:2894,y:697}, gps:{lat:35.641230,lng:139.300170} },
  { img:{x:140,y:2262}, gps:{lat:35.638620,lng:139.294578} },
  { img:{x:3239,y:2442}, gps:{lat:35.638278,lng:139.300813} }
];

function computeAffine(points){
  let A=[],B=[];
  points.forEach(p=>{
    const lng=p.gps.lng, lat=-p.gps.lat;
    A.push([lng,lat,1,0,0,0],[0,0,0,lng,lat,1]);
    B.push(p.img.x,p.img.y);
  });
  const X=math.multiply(
    math.inv(math.multiply(math.transpose(A),A)),
    math.multiply(math.transpose(A),B)
  );
  return {a:X[0],b:X[1],c:X[2],d:X[3],e:X[4],f:X[5]};
}
const affine = computeAffine(controlPoints);

function gpsToImage(lat,lng){
  lat=-lat;
  return {
    x: affine.a*lng + affine.b*lat + affine.c,
    y: affine.d*lng + affine.e*lat + affine.f
  };
}

/* ===============================
â‘¢ åœ°å›³è¡¨ç¤º
================================ */
const bounds=[[0,0],[imageHeight,imageWidth]];
const map=L.map("map",{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
L.imageOverlay("map.jpg",bounds).addTo(map);
map.fitBounds(bounds);

/* ===============================
â‘£ ğŸ“ã‚¢ã‚¤ã‚³ãƒ³
================================ */
const bluePin=L.divIcon({
  className:"pin-blue",
  html:"ğŸ“",
  iconSize:[48,48],
  iconAnchor:[24,48]
});
const redPin=L.divIcon({
  className:"pin-red",
  html:"ğŸ“",
  iconSize:[48,48],
  iconAnchor:[24,48]
});

/* ===============================
â‘¤ é“ãƒ‡ãƒ¼ã‚¿ï¼ˆâ˜…ã“ã“ã‚’æ›¸ãè¶³ã™ï¼‰
================================ */
const roads = [
  // ä¾‹ï¼šé“â‘ 
  [
    [200,1100],
    [400,1100],
    [600,1050],
    [800,1000]
  ],
  // ä¾‹ï¼šé“â‘¡
  [
    [800,1000],
    [900,900],
    [1000,850]
  ]
];

// é“ã‚’è¡¨ç¤º
roads.forEach(r=>{
  L.polyline(r.map(p=>[p[1],p[0]]),{
    color:"#aaa", weight:6
  }).addTo(map);
});

/* ===============================
â‘¥ ç¾åœ¨åœ°
================================ */
let currentMarker=null;
document.getElementById("gpsBtn").onclick=()=>{
  navigator.geolocation.watchPosition(pos=>{
    const p=gpsToImage(pos.coords.latitude,pos.coords.longitude);
    if(!currentMarker){
      currentMarker=L.marker([p.y,p.x],{icon:bluePin}).addTo(map);
    }else{
      currentMarker.setLatLng([p.y,p.x]);
    }
  },e=>alert(e.message),{enableHighAccuracy:true});
};

/* ===============================
â‘¦ ç›®çš„åœ°
================================ */
let goalMarker=null;
map.on("click",e=>{
  if(goalMarker) map.removeLayer(goalMarker);
  goalMarker=L.marker(e.latlng,{icon:redPin}).addTo(map);
});
</script>
</body>
</html>
