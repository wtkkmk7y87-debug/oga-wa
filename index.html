<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPSãƒŠãƒ“ï¼ˆå®Œæˆç‰ˆï¼‰</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- è¡Œåˆ—è¨ˆç®— -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}

/* GPSãƒœã‚¿ãƒ³ */
#gpsBtn {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1000;
  font-size: 18px;
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  background: #2c7be5;
  color: white;
}

/* çŠ¶æ…‹è¡¨ç¤º */
#status {
  position: fixed;
  bottom: 15px;
  left: 15px;
  z-index: 1000;
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 10px 14px;
  border-radius: 8px;
  display: none;
  font-size: 14px;
}

/* æ–¹è§’ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆä¸Šï¼åŒ—ï¼‰ */
#compass {
  position: fixed;
  top: 15px;
  right: 15px;
  z-index: 1000;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
  border: 2px solid #333;
  font-weight: bold;
  text-align: center;
}

#compass .n { position: absolute; top: 4px; left: 50%; transform: translateX(-50%); }
#compass .s { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
#compass .e { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); }
#compass .w { position: absolute; left: 6px; top: 50%; transform: translateY(-50%); }
</style>
</head>

<body>

<button id="gpsBtn">ğŸ“ GPSå†å–å¾—</button>
<div id="status"></div>

<!-- æ–¹è§’è¡¨ç¤º -->
<div id="compass">
  <div class="n">N</div>
  <div class="e">E</div>
  <div class="s">S</div>
  <div class="w">W</div>
</div>

<div id="map"></div>

<script>
/* ===============================
â‘  ç”»åƒã‚µã‚¤ã‚º
================================ */
const imageWidth  = 3312;
const imageHeight = 3392;

/* ===============================
â‘¡ å¯¾å¿œç‚¹ï¼ˆã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
================================ */
const controlPoints = [
  { img:{x:179,  y:1211}, gps:{lat:35.640376, lng:139.294706} },
  { img:{x:2894, y:697},  gps:{lat:35.641230, lng:139.300170} },
  { img:{x:140,  y:2262}, gps:{lat:35.638620, lng:139.294578} },
  { img:{x:3239,y:2442}, gps:{lat:35.638278, lng:139.300813} }
];

/* ===============================
â‘¢ ã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›è¨ˆç®—
================================ */
function computeAffine(points) {
  let A = [], B = [];
  points.forEach(p => {
    const lng = p.gps.lng;
    const lat = -p.gps.lat;   // ç·¯åº¦åè»¢
    A.push([lng, lat, 1, 0, 0, 0]);
    A.push([0, 0, 0, lng, lat, 1]);
    B.push(p.img.x);
    B.push(p.img.y);
  });
  const AT = math.transpose(A);
  const X = math.multiply(
    math.inv(math.multiply(AT, A)),
    math.multiply(AT, B)
  );
  return { a:X[0], b:X[1], c:X[2], d:X[3], e:X[4], f:X[5] };
}
const affine = computeAffine(controlPoints);

/* ===============================
â‘£ GPS â†’ ç”»åƒåº§æ¨™ï¼ˆYè»¸è£œæ­£ï¼‰
================================ */
function gpsToImage(lat, lng) {
  lat = -lat;
  const x = affine.a * lng + affine.b * lat + affine.c;
  const y = affine.d * lng + affine.e * lat + affine.f;

  return {
    x: x,
    y: imageHeight - y   // ä¸Šï¼åŒ—ã«è£œæ­£
  };
}

/* ===============================
â‘¤ Leaflet åˆæœŸåŒ–
================================ */
const bounds = [[0,0],[imageHeight,imageWidth]];
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2
});
L.imageOverlay("map.jpg", bounds).addTo(map);
map.fitBounds(bounds);

/* ===============================
â‘¥ ã‚¢ã‚¤ã‚³ãƒ³
================================ */
const currentIcon = L.icon({
  iconUrl: "current.png",   // çŸ¢å°ç”»åƒ
  iconSize: [40,40],
  iconAnchor: [20,20]
});

const goalIcon = L.icon({
  iconUrl: "goal.png",
  iconSize: [48,48],
  iconAnchor: [24,24]
});

/* ===============================
â‘¦ ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
================================ */
let currentMarker = null;
let goalMarker = null;
let accuracyCircle = null;
let routeLine = null;

const status = document.getElementById("status");
const meterToPixel = 1.2;

/* ===============================
â‘§ ç«¯æœ«ã®å‘ãï¼ˆã‚³ãƒ³ãƒ‘ã‚¹ï¼‰
================================ */
let deviceHeading = 0; // åŒ—=0Â°

function startCompass() {
  // iPhone å¯¾å¿œï¼ˆè¨±å¯ãŒå¿…è¦ï¼‰
  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    DeviceOrientationEvent.requestPermission().then(permission => {
      if (permission === "granted") {
        window.addEventListener("deviceorientation", handleOrientation, true);
      }
    });
  } 
  // Androidãªã©
  else {
    window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  }
}

function handleOrientation(event) {
  if (event.alpha == null) return;

  // åŒ—ã‚’0åº¦ã«è£œæ­£
  deviceHeading = 360 - event.alpha;
  updateArrowRotation();
}

function updateArrowRotation() {
  if (!currentMarker) return;

  const iconEl = currentMarker.getElement();
  if (!iconEl) return;

  iconEl.style.transform = `rotate(${deviceHeading}deg)`;
}

/* ===============================
â‘¨ GPSå‡¦ç†ï¼ˆè‡ªå‹•é–‹å§‹ï¼‰
================================ */
function startGPS() {
  navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude, accuracy } = pos.coords;

      if (accuracy > 1000) {
        status.textContent = "GPSç²¾åº¦ãŒä½ã™ãã¾ã™";
        status.style.display = "block";
        return;
      }

      const p = gpsToImage(latitude, longitude);

      if (
        p.x < 0 || p.x > imageWidth ||
        p.y < 0 || p.y > imageHeight
      ) {
        status.textContent = "ç¾åœ¨åœ°ã¯åœ°å›³ã®ç¯„å›²å¤–ã§ã™";
        status.style.display = "block";
        return;
      }

      status.style.display = "none";
      const currentLatLng = L.latLng(p.y, p.x);

      /* ç¾åœ¨åœ° */
      if (!currentMarker) {
        currentMarker = L.marker(currentLatLng, {
          icon: currentIcon
        }).addTo(map);
      } else {
        currentMarker.setLatLng(currentLatLng);
      }

      updateArrowRotation();   // â† å‘ãã‚’åæ˜ 

      /* GPSç²¾åº¦å†† */
      const radiusPx = accuracy * meterToPixel;
      if (!accuracyCircle) {
        accuracyCircle = L.circle(currentLatLng, {
          radius: radiusPx,
          color: "blue",
          weight: 1,
          fillColor: "blue",
          fillOpacity: 0.15
        }).addTo(map);
      } else {
        accuracyCircle.setLatLng(currentLatLng);
        accuracyCircle.setRadius(radiusPx);
      }

      /* ãƒ«ãƒ¼ãƒˆæ›´æ–° */
      if (goalMarker) {
        drawRouteLine(currentLatLng, goalMarker.getLatLng());
      }
    },
    err => alert(err.message),
    { enableHighAccuracy: true }
  );
}

/* ===============================
â‘© ç›®çš„åœ°ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰
================================ */
map.on("click", e => {
  if (goalMarker) map.removeLayer(goalMarker);

  goalMarker = L.marker(e.latlng, {
    icon: goalIcon
  }).addTo(map);

  if (currentMarker) {
    drawRouteLine(
      currentMarker.getLatLng(),
      goalMarker.getLatLng()
    );
  }
});

/* ===============================
â‘ª ç¾åœ¨åœ°ã€œç›®çš„åœ°ã®ç·š
================================ */
function drawRouteLine(from, to) {
  if (routeLine) {
    routeLine.setLatLngs([from, to]);
  } else {
    routeLine = L.polyline([from, to], {
      color: "orange",
      weight: 4,
      dashArray: "6,6"
    }).addTo(map);
  }
}

/* ===============================
â‘« èµ·å‹•å‡¦ç†
================================ */
window.addEventListener("load", () => {
  startGPS();
  startCompass();
});
document.getElementById("gpsBtn").onclick = startGPS;

</script>
</body>
</html>
