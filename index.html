<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPS ãƒŠãƒ“</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
button {
  position: fixed;
  left: 10px;
  top: 10px;
  z-index: 1000;
  padding: 6px 10px;
}
</style>
</head>

<body>

<button id="btn-gps">ğŸ“ GPSç¾åœ¨åœ°</button>
<div id="map"></div>

<script>
/* ===============================
   1ï¸âƒ£ åœ°å›³ç”»åƒã‚µã‚¤ã‚º
================================ */
const imageWidth  = 3312;
const imageHeight = 3392;

/* ===============================
   2ï¸âƒ£ ç”»åƒã¨GPSã®å¯¾å¿œç‚¹ï¼ˆè¶…é‡è¦ï¼‰
   â€» Googleãƒãƒƒãƒ—ã§å–å¾—ã—ã¦æ›¸ãæ›ãˆã‚‹
================================ */
/* ===============================
 2ï¸âƒ£ ç”»åƒã¨GPSã®å¯¾å¿œç‚¹ï¼ˆè¶…é‡è¦ï¼‰
================================ */

// â˜…ã“ã“ã«ç½®ã
const controlPoints = [
  {
    img: { x: 420, y: 380 },
    gps: { lat: 35.639812, lng: 139.296120 }
  },
  {
    img: { x: 2900, y: 3100 },
    gps: { lat: 35.638450, lng: 139.299980 }
  },
  {
    img: { x: 1600, y: 1200 },
    gps: { lat: 35.639100, lng: 139.298200 }
  }
];


/* ===============================
   3ï¸âƒ£ Leaflet åˆæœŸåŒ–
================================ */
const bounds = [[0, 0], [imageHeight, imageWidth]];

const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2
});

L.imageOverlay('map.png', bounds).addTo(map);
map.fitBounds(bounds);

/* ===============================
   4ï¸âƒ£ ãƒãƒ¼ã‚«ãƒ¼é¡
================================ */
let startMarker = null;
let goalMarker  = null;
let routeLine   = null;

/* ===============================
   5ï¸âƒ£ GPS â†’ ç”»åƒåº§æ¨™ï¼ˆæ­£ç¢ºå¤‰æ›ï¼‰
================================ */
function gpsToImage(lat, lng) {
  const xRatio =
    (lng - gpsTopLeft.lng) /
    (gpsBottomRight.lng - gpsTopLeft.lng);

  const yRatio =
    (gpsTopLeft.lat - lat) /
    (gpsTopLeft.lat - gpsBottomRight.lat);

  return {
    x: imgTopLeft.x + xRatio * (imgBottomRight.x - imgTopLeft.x),
    y: imgTopLeft.y + yRatio * (imgBottomRight.y - imgTopLeft.y)
  };
}

/* ===============================
   6ï¸âƒ£ ãƒ«ãƒ¼ãƒˆæç”»
================================ */
function drawRoute() {
  if (!startMarker || !goalMarker) return;

  if (routeLine) map.removeLayer(routeLine);

  routeLine = L.polyline([
    startMarker.getLatLng(),
    goalMarker.getLatLng()
  ], {
    color: 'blue',
    weight: 4
  }).addTo(map);
}

/* ===============================
   7ï¸âƒ£ GPSç¾åœ¨åœ°å–å¾—
================================ */
document.getElementById("btn-gps").onclick = () => {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    const p = gpsToImage(latitude, longitude);

    if (startMarker) map.removeLayer(startMarker);

    startMarker = L.marker([p.y, p.x])
      .addTo(map)
      .bindPopup("ç¾åœ¨åœ°")
      .openPopup();

    drawRoute();
  }, () => {
    alert("GPSã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
  });
};

/* ===============================
   8ï¸âƒ£ ç›®çš„åœ°è¨­å®šï¼ˆåœ°å›³ã‚¿ãƒƒãƒ—ï¼‰
================================ */
map.on("click", e => {
  if (goalMarker) map.removeLayer(goalMarker);

  goalMarker = L.marker(e.latlng)
    .addTo(map)
    .bindPopup("ç›®çš„åœ°")
    .openPopup();

  drawRoute();
});
</script>

</body>
</html>

