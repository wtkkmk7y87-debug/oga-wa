<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ç”»åƒåœ°å›³ Ã— GPSãƒŠãƒ“</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- è¡Œåˆ—è¨ˆç®— -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
}
#map {
  width: 100%;
  height: 100%;
}
button {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1000;
}
#status {
  position: fixed;
  bottom: 10px;
  left: 10px;
  z-index: 1000;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  display: none;
}
</style>
</head>

<body>

<button id="btn-gps">ğŸ“ GPSé–‹å§‹</button>
<div id="status"></div>
<div id="map"></div>

<script>
/* ===============================
 â‘  ç”»åƒã‚µã‚¤ã‚ºï¼ˆâ†è¶…é‡è¦ï¼‰
================================ */
const imageWidth  = 1264;
const imageHeight = 1295;

/* ===============================
 â‘¡ å¯¾å¿œç‚¹ï¼ˆç”»åƒåº§æ¨™ Ã— GPSï¼‰
================================ */
const controlPoints = [
  { img:{x:  68, y: 463}, gps:{lat:35.640376, lng:139.294706} },
  { img:{x:1102, y: 265}, gps:{lat:35.641230, lng:139.300170} },
  { img:{x:  53, y: 866}, gps:{lat:35.638620, lng:139.294578} },
  { img:{x:1235, y: 934}, gps:{lat:35.638278, lng:139.300813} }
];

/* ===============================
 â‘¢ ã‚¢ãƒ•ã‚£ãƒ³å¤‰æ›è¨ˆç®—
================================ */
function computeAffine(points) {
  let A = [], B = [];
  points.forEach(p => {
    const lng = p.gps.lng;
    const lat = -p.gps.lat;
    A.push([lng, lat, 1, 0, 0, 0]);
    A.push([0, 0, 0, lng, lat, 1]);
    B.push(p.img.x);
    B.push(p.img.y);
  });
  const AT = math.transpose(A);
  const X = math.multiply(
    math.inv(math.multiply(AT, A)),
    math.multiply(AT, B)
  );
  return {
    a:X[0], b:X[1], c:X[2],
    d:X[3], e:X[4], f:X[5]
  };
}
const affine = computeAffine(controlPoints);

/* ===============================
 â‘£ GPS â†’ ç”»åƒåº§æ¨™
================================ */
function gpsToImage(lat, lng) {
  lat = -lat;
  return {
    x: affine.a * lng + affine.b * lat + affine.c,
    y: affine.d * lng + affine.e * lat + affine.f
  };
}

/* ===============================
 â‘¤ Leaflet åˆæœŸåŒ–
================================ */
const bounds = [[0,0],[imageHeight,imageWidth]];
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2
});

L.imageOverlay("map.jpg", bounds).addTo(map);
map.fitBounds(bounds);

/* ===============================
 â‘¥ ãƒãƒ¼ã‚«ãƒ¼ãƒ»ãƒ«ãƒ¼ãƒˆ
================================ */
let startMarker = null;
let goalMarker  = null;
let routeLine   = null;

function drawRoute() {
  if (!startMarker || !goalMarker) return;
  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(
    [startMarker.getLatLng(), goalMarker.getLatLng()],
    { color:"blue", weight:4 }
  ).addTo(map);
}

/* ===============================
 â‘¦ GPSç›£è¦–ï¼ˆè‡ªå‹•è¡¨ç¤ºï¼‰
================================ */
const status = document.getElementById("status");
let watchId = null;

document.getElementById("btn-gps").onclick = () => {
  if (watchId !== null) return;

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      const p = gpsToImage(latitude, longitude);

      // ç¯„å›²å¤–
      if (
        p.x < 0 || p.x > imageWidth ||
        p.y < 0 || p.y > imageHeight
      ) {
        status.textContent = "ç¾åœ¨åœ°ã¯åœ°å›³ã®ç¯„å›²å¤–ã§ã™";
        status.style.display = "block";
        if (startMarker) {
          map.removeLayer(startMarker);
          startMarker = null;
        }
        return;
      }

      // ç¯„å›²å†…
      status.style.display = "none";

      if (!startMarker) {
        startMarker = L.marker([p.y, p.x])
          .addTo(map)
          .bindPopup("ç¾åœ¨åœ°")
          .openPopup();
      } else {
        startMarker.setLatLng([p.y, p.x]);
      }
      drawRoute();
    },
    err => alert(err.message),
    { enableHighAccuracy:true }
  );
};

/* ===============================
 â‘§ ç›®çš„åœ°ã‚¯ãƒªãƒƒã‚¯
================================ */
map.on("click", e => {
  if (goalMarker) map.removeLayer(goalMarker);
  goalMarker = L.marker(e.latlng)
    .addTo(map)
    .bindPopup("ç›®çš„åœ°")
    .openPopup();
  drawRoute();
});
</script>

</body>
</html>
